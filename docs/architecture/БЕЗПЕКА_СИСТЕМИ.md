# Безпека системи

> Оновлено: 2026-02-15
> Джерело: docs/security.md (перекладено та оновлено)
> Архітектура: Mastra + Inngest

---

## Принципи

1. **Secure by Default** — жодний доступ без автентифікації
2. **Defense in Depth** — декілька рівнів захисту
3. **Least Privilege** — мінімально необхідний доступ
4. **No Secrets in Code** — усі секрети у змінних середовища

---

## Модель загроз

### Активи

- Зміст нотаток (інтелектуальна власність)
- Визначення агентів (`_agent.md`, `pseudocode.md`)
- Credentials Owner
- Коди доступу до зон
- Сесійні токени
- Proposals та audit log

### Загрози

| Загроза | Мітигація |
|---------|-----------|
| Несанкціонований доступ | Access Gate, JWT auth, Zone Consent Gate |
| Крадіжка credentials | Хешування паролів, HTTPS |
| Перехоплення сесії | HttpOnly cookies, короткий TTL |
| Повторне використання токена | Expiration, refresh rotation |
| XSS | CSP, санітизація вводу |
| CSRF | SameSite cookies |
| Несанкціонована мутація знань | Proposal lifecycle, Consent Gates |
| Ескалація привілеїв агента | `safe_outputs[]` обмеження, Validation Gate |

---

## Автентифікація

### Зберігання паролів

```javascript
// НІКОЛИ не зберігати plaintext
// SHA-256 хеш із secret salt
const hash = await sha256(password + JWT_SECRET);
await KV.put('owner:password_hash', hash);
```

### Структура JWT

```javascript
// Header
{ "alg": "HS256", "typ": "JWT" }

// Payload
{
  "sub": "owner",        // або "zone:zone_id"
  "iat": 1705312800,     // Issued at
  "exp": 1705399200,     // Expiration (24h)
  "scope": "full"        // або "zone:zone_id"
}

// Signature
HMAC-SHA256(header + payload, JWT_SECRET)
```

### Життєвий цикл токена

```
Login → Видача токена (24h TTL)
       │
       ├── Використання → Валідація підпису + expiry
       │
       ├── Refresh → Новий токен, інвалідація старого
       │
       └── Logout → Очистка cookie, blacklist токена
```

---

## Безпека агентної підсистеми

### Обмеження агентів

| Обмеження | Механізм | Джерело |
|-----------|----------|--------|
| Агент не може змінювати знання напряму | Proposal lifecycle | INBOX_ТА_PROPOSAL.md §0 |
| Агент обмежений переліченими tools | `tools[]` у `_agent.md` | КОНТРАКТ_АГЕНТА_V1.md §2.2 |
| Агент може створювати лише визначені safe_outputs | `safe_outputs[]` у `_agent.md` | КОНТРАКТ_АГЕНТА_V1.md §2.2 |
| Агент не може модифікувати auto-approve правила | Owner-only mutation | INBOX_ТА_PROPOSAL.md §7 |
| Агент не може активувати себе | Agent Activation Gate = Owner consent | INBOX_ТА_PROPOSAL.md §4.6 |

### Validation Gate (Inbox)

При прийомі intent від агента Worker перевіряє:
- Ідентичність агента (agent identity valid)
- `intent.action` ∈ `safe_outputs[]` агента
- Target існує
- Rate limit не перевищено

---

## CORS

```javascript
'Access-Control-Allow-Origin': 'https://garden.exodus.pp.ua'
'Access-Control-Allow-Methods': 'GET, POST, DELETE, OPTIONS'
'Access-Control-Allow-Headers': 'Content-Type, Authorization'
'Access-Control-Allow-Credentials': 'true'
```

---

## Security Headers

```javascript
'Strict-Transport-Security': 'max-age=31536000; includeSubDomains'
'X-Content-Type-Options': 'nosniff'
'X-Frame-Options': 'DENY'
'Content-Security-Policy': "default-src 'self'"
```

---

## Управління секретами

### Необхідні секрети

| Секрет | Призначення | Ротація |
|--------|------------|---------|
| `JWT_SECRET` | Підпис токенів | Щоквартально |
| `MINIO_ACCESS_KEY` | S3 access | Щоквартально |
| `MINIO_SECRET_KEY` | S3 auth | Щоквартально |

### Зберігання

- **Cloudflare:** Environment Variables (зашифровані)
- **Ніколи:** Git, логи, клієнтський код

---

## Аудит-лог

Аудит-лог зберігається у MinIO: `/audit/events/<yyyy-mm>/<eventId>.json`

```json
{
  "event": "auth.login",
  "success": true,
  "ip": "1.2.3.4",
  "timestamp": "2026-02-15T12:00:00Z"
}
```

---

## Реагування на інциденти

### Компрометація секрету

1. Негайна ротація секрету
2. Інвалідація усіх сесій
3. Перегляд логів доступу
4. Повідомлення постраждалих

### Несанкціонований доступ

1. Блокування source IP
2. Інвалідація токенів
3. Перегляд та патч вразливості
4. Документування інциденту

---

*Цей документ є канонічною специфікацією безпеки системи Garden Seedling.*
